config system admin
edit admin
set password fortinet
next
end
config system global
set hostname FortiGateDUT2
set admintimeout 480
set timezone Europe/Istanbul
end
config system interface
edit port1
set alias management
set mode dhcp
set allowaccess ping https ssh fgfm
next
edit port2
set alias shared
set mode dhcp
set allowaccess ping https ssh fgfm
next
edit port3
set alias server
set mode dhcp
set allowaccess ping https ssh fgfm
next
end
config firewall address
    edit Client_Subnet
        set subnet 172.16.2.0 255.255.255.0
    next
    edit Server_Subnet
        set associated-interface port3
        set subnet 172.16.3.0 255.255.255.0
    next
end

config firewall addrgrp
    edit CLIENT_GROUP
        set member Client_Subnet
    next
    edit SERVER_GROUP
        set member Server_Subnet
end

config vpn ipsec phase1-interface
    edit IPSEC1
        set interface port2
        set ike-version 2
        set peertype any
        set net-device disable
        set aggregate-member enable
        set proposal aes128gcm-prfsha1
        set nattraversal disable
        set network-overlay enable
        set network-id 1
        set remote-gw 172.16.1.100
        set psksecret fortinet
        set packet-redistribution enable
    next
    edit IPSEC2
        set interface port2
        set ike-version 2
        set peertype any
        set net-device disable
        set aggregate-member enable
        set proposal aes128gcm-prfsha1
        set nattraversal disable
        set network-overlay enable
        set network-id 2
        set remote-gw 172.16.1.100
        set psksecret fortinet
        set packet-redistribution enable
    next
    edit IPSEC3
        set interface port2
        set ike-version 2
        set peertype any
        set net-device disable
        set aggregate-member enable
        set proposal aes128gcm-prfsha1
        set nattraversal disable
        set network-overlay enable
        set network-id 3
        set remote-gw 172.16.1.100
        set psksecret fortinet
        set packet-redistribution enable
    next
    edit IPSEC4
        set interface port2
        set ike-version 2
        set peertype any
        set net-device disable
        set aggregate-member enable
        set proposal aes128gcm-prfsha1
        set nattraversal disable
        set network-overlay enable
        set network-id 4
        set remote-gw 172.16.1.100
        set psksecret fortinet
        set packet-redistribution enable
    next
    edit IPSEC5
        set interface port2
        set ike-version 2
        set peertype any
        set net-device disable
        set aggregate-member enable
        set proposal aes128gcm-prfsha1
        set nattraversal disable
        set network-overlay enable
        set network-id 5
        set remote-gw 172.16.1.100
        set psksecret fortinet
        set packet-redistribution enable
    next
    edit IPSEC6
        set interface port2
        set ike-version 2
        set peertype any
        set net-device disable
        set aggregate-member enable
        set proposal aes128gcm-prfsha1
        set nattraversal disable
        set network-overlay enable
        set network-id 6
        set remote-gw 172.16.1.100
        set psksecret fortinet
        set packet-redistribution enable
    next
    edit IPSEC7
        set interface port2
        set ike-version 2
        set peertype any
        set net-device disable
        set aggregate-member enable
        set proposal aes128gcm-prfsha1
        set nattraversal disable
        set network-overlay enable
        set network-id 7
        set remote-gw 172.16.1.100
        set psksecret fortinet
        set packet-redistribution enable
    next
    edit IPSEC8
        set interface port2
        set ike-version 2
        set peertype any
        set net-device disable
        set aggregate-member enable
        set proposal aes128gcm-prfsha1
        set nattraversal disable
        set network-overlay enable
        set network-id 8
        set remote-gw 172.16.1.100
        set psksecret fortinet
        set packet-redistribution enable
    next
end

config vpn ipsec phase2-interface
    edit IPSEC1
        set phase1name IPSEC1
        set proposal aes128gcm
        set pfs disable
        set auto-negotiate enable
        set src-subnet 172.16.3.0 255.255.255.0
        set dst-subnet 172.16.2.0 255.255.255.0
    next
    edit IPSEC2
        set phase1name IPSEC2
        set proposal aes128gcm
        set pfs disable
        set auto-negotiate enable
        set src-subnet 172.16.3.0 255.255.255.0
        set dst-subnet 172.16.2.0 255.255.255.0
    next
    edit IPSEC3
        set phase1name IPSEC3
        set proposal aes128gcm
        set pfs disable
        set auto-negotiate enable
        set src-subnet 172.16.3.0 255.255.255.0
        set dst-subnet 172.16.2.0 255.255.255.0
    next
    edit IPSEC4
        set phase1name IPSEC4
        set proposal aes128gcm
        set pfs disable
        set auto-negotiate enable
        set src-subnet 172.16.3.0 255.255.255.0
        set dst-subnet 172.16.2.0 255.255.255.0
    next
    edit IPSEC5
        set phase1name IPSEC5
        set proposal aes128gcm
        set pfs disable
        set auto-negotiate enable
        set src-subnet 172.16.3.0 255.255.255.0
        set dst-subnet 172.16.2.0 255.255.255.0
    next
    edit IPSEC6
        set phase1name IPSEC6
        set proposal aes128gcm
        set pfs disable
        set auto-negotiate enable
        set src-subnet 172.16.3.0 255.255.255.0
        set dst-subnet 172.16.2.0 255.255.255.0
    next
    edit IPSEC7
        set phase1name IPSEC7
        set proposal aes128gcm
        set pfs disable
        set auto-negotiate enable
        set src-subnet 172.16.3.0 255.255.255.0
        set dst-subnet 172.16.2.0 255.255.255.0
    next
    edit IPSEC8
        set phase1name IPSEC8
        set proposal aes128gcm
        set pfs disable
        set auto-negotiate enable
        set src-subnet 172.16.3.0 255.255.255.0
        set dst-subnet 172.16.2.0 255.255.255.0
    next
end

config system ipsec-aggregate
    edit IPSEC_AGGREGATE
        set member IPSEC1 IPSEC2 IPSEC3 IPSEC4 IPSEC5 IPSEC6 IPSEC7 IPSEC8
        set algorithm L4
    next
end

config system interface
edit IPSEC_AGGREGATE
set vdom root
set type tunnel
next
end

config firewall policy
    edit 1
        set name IPSEC_OUTGOING_POLICY
        set srcintf port3
        set dstintf IPSEC_AGGREGATE
        set action accept
        set srcaddr SERVER_GROUP
        set dstaddr CLIENT_GROUP
        set schedule always
        set service ALL
        set logtraffic all
    next
    edit 2
        set name IPSEC_INCOMING_POLICY
        set srcintf IPSEC_AGGREGATE
        set dstintf port3
        set action accept
        set srcaddr CLIENT_GROUP
        set dstaddr SERVER_GROUP
        set schedule always
        set service ALL
        set logtraffic all
    next
end

config router static
    edit 1
        set dst 172.16.2.0 255.255.255.0
        set device IPSEC_AGGREGATE
    next
end

config system affinity-interrupt
    edit 1
        set interrupt port2-Tx-Rx-0
        set affinity-cpumask 0x1
        next
    edit 2
        set interrupt port2-Tx-Rx-1
        set affinity-cpumask 0x2
        next
    edit 3
        set interrupt port2-Tx-Rx-2
        set affinity-cpumask 0x4
        next
    edit 4
        set interrupt port2-Tx-Rx-3
        set affinity-cpumask 0x8
        next
    edit 5
        set interrupt port2-Tx-Rx-4
        set affinity-cpumask 0x10
        next
    edit 6
        set interrupt port2-Tx-Rx-5
        set affinity-cpumask 0x20
        next
    edit 7
        set interrupt port2-Tx-Rx-6
        set affinity-cpumask 0x40
        next
    edit 8
        set interrupt port2-Tx-Rx-7
        set affinity-cpumask 0x80
        next
    edit 9
        set interrupt port3-Tx-Rx-0
        set affinity-cpumask 0x100
        next
    edit 10
        set interrupt port3-Tx-Rx-1
        set affinity-cpumask 0x200
        next
    edit 11
        set interrupt port3-Tx-Rx-2
        set affinity-cpumask 0x400
        next
    edit 12
        set interrupt port3-Tx-Rx-3
        set affinity-cpumask 0x800
        next
    edit 13
        set interrupt port3-Tx-Rx-4
        set affinity-cpumask 0x1000
        next
    edit 14
        set interrupt port3-Tx-Rx-5
        set affinity-cpumask 0x2000
        next
    edit 15
        set interrupt port3-Tx-Rx-6
        set affinity-cpumask 0x4000
        next
    edit 16
        set interrupt port3-Tx-Rx-7
        set affinity-cpumask 0x8000
        next
end